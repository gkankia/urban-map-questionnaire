<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>áƒ’áƒáƒ›áƒáƒ’áƒšáƒ”áƒ¯áƒMAP - Three Word Grid</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'JetBrains Mono', monospace; color: #404040; }
        .map-container { display: flex; height: 100vh; }
        #map { flex: 1; }
        .sidebar { width: 420px; overflow-y: auto; background: #fff; border-left: 1px solid #ddd; padding: 20px; }
        h1 { font-size: 20px; margin-bottom: 15px; color: #6c86cf; }
        .section { margin-bottom: 18px; padding: 14px; background: #f9f9f9; border-radius: 5px; }
        .section h3 { font-size: 14px; margin-bottom: 10px; color: #333; }
        label { display: block; margin: 10px 0 5px; font-size: 13px; font-weight: bold; }
        select, input { width: 100%; padding: 8px; font-size: 13px; border: 1px solid #ddd; border-radius: 3px; font-family: inherit; }
        .toggle-group { display: flex; gap: 10px; margin: 10px 0; }
        .toggle { flex: 1; padding: 10px; text-align: center; border: 2px solid #6c86cf; border-radius: 5px; cursor: pointer; transition: all 0.2s; font-size: 13px; }
        .toggle:hover, .toggle.active { background: #6c86cf; color: white; }
        button { width: 100%; padding: 10px; background: #6c86cf; color: white; border: none; border-radius: 5px; font-size: 14px; font-weight: bold; cursor: pointer; margin-top: 8px; }
        button:hover { background: #5a74b8; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); }
        .modal-content { background: white; margin: 3% auto; padding: 25px; border-radius: 10px; max-width: 600px; max-height: 85vh; overflow-y: auto; }
        .close { float: right; font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; }
        .close:hover { color: #000; }
        .question { margin: 15px 0; padding: 12px; background: #f9f9f9; border-left: 3px solid #6c86cf; }
        .question label { margin: 0 0 8px 0; }
        .radio-group label { display: flex; align-items: center; margin: 5px 0; font-weight: normal; }
        .radio-group input { width: auto; margin-right: 8px; }
        .results { background: #e3f0fc; padding: 15px; border-radius: 5px; margin-top: 15px; }
        .info-box { padding: 10px; background: #e3f0fc; border-radius: 3px; margin-bottom: 15px; font-size: 12px; line-height: 1.5; }
        .three-word-name { font-size: 16px; font-weight: bold; color: #6c86cf; margin: 5px 0; }
        .tab-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 12px; background: #e0e0e0; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 13px; }
        .tab-btn.active { background: #6c86cf; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .aggregate-stat { padding: 8px; margin: 5px 0; background: #f5f5f5; border-radius: 3px; }
        .chart-bar { height: 20px; background: #6c86cf; border-radius: 2px; margin: 3px 0; position: relative; }
        .chart-label { position: absolute; left: 5px; color: white; font-size: 11px; line-height: 20px; font-weight: bold; }
        .status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
        .status-connected { background: #28a745; }
        .status-disconnected { background: #dc3545; }
        @media (max-width: 768px) {
            .map-container { flex-direction: column; }
            .sidebar { width: 100%; border-left: none; border-top: 1px solid #ddd; height: 50vh; }
            #map { height: 50vh; }
        }
    </style>
</head>
<body>
    <!-- Questionnaire Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 style="text-align: center; color: #6c86cf; margin-bottom: 15px;">áƒ™áƒ˜áƒ—áƒ®áƒ•áƒáƒ áƒ˜</h2>
            <div id="cellInfo" class="info-box"></div>
            
            <form id="surveyForm">
                <div class="question">
                    <label>1. áƒ áƒ áƒáƒ¡áƒáƒ™áƒ˜áƒ¡ áƒ®áƒáƒ áƒ—?</label>
                    <select name="age" required>
                        <option value="">áƒáƒ˜áƒ áƒ©áƒ˜áƒ”áƒ—...</option>
                        <option value="18-25">18-25</option>
                        <option value="26-35">26-35</option>
                        <option value="36-45">36-45</option>
                        <option value="46-55">46-55</option>
                        <option value="56+">56+</option>
                    </select>
                </div>
                
                <div class="question">
                    <label>2. áƒ¡áƒ¥áƒ”áƒ¡áƒ˜:</label>
                    <div class="radio-group">
                        <label><input type="radio" name="gender" value="male" required> áƒ›áƒáƒ›áƒ áƒáƒ‘áƒ˜áƒ—áƒ˜</label>
                        <label><input type="radio" name="gender" value="female"> áƒ›áƒ“áƒ”áƒ“áƒ áƒáƒ‘áƒ˜áƒ—áƒ˜</label>
                        <label><input type="radio" name="gender" value="other"> áƒ¡áƒ®áƒ•áƒ</label>
                    </div>
                </div>
                
                <div class="question">
                    <label>3. áƒ áƒáƒ›áƒ”áƒš áƒáƒáƒ áƒ¢áƒ˜áƒáƒ¡ áƒ›áƒ˜áƒ¡áƒªáƒ”áƒ›áƒ— áƒ®áƒ›áƒáƒ¡?</label>
                    <select name="vote" required>
                        <option value="">áƒáƒ˜áƒ áƒ©áƒ˜áƒ”áƒ—...</option>
                        <option value="qocebi">áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜ áƒáƒªáƒœáƒ”áƒ‘áƒ</option>
                        <option value="lelo">áƒšáƒ”áƒšáƒ</option>
                        <option value="gakharia">áƒ’áƒáƒ®áƒáƒ áƒ˜áƒ</option>
                        <option value="boycott">áƒ‘áƒáƒ˜áƒ™áƒáƒ¢áƒ˜</option>
                        <option value="undecided">áƒ’áƒáƒ“áƒáƒ£áƒ¬áƒ§áƒ•áƒ”áƒ¢áƒ”áƒšáƒ˜</option>
                    </select>
                </div>
                
                <div class="question">
                    <label>4. áƒ”áƒ™áƒáƒœáƒáƒ›áƒ˜áƒ™áƒ˜áƒ¡ áƒ¨áƒ”áƒ¤áƒáƒ¡áƒ”áƒ‘áƒ:</label>
                    <select name="economy" required>
                        <option value="">áƒáƒ˜áƒ áƒ©áƒ˜áƒ”áƒ—...</option>
                        <option value="very_good">áƒ«áƒáƒšáƒ˜áƒáƒœ áƒ™áƒáƒ áƒ’áƒ˜</option>
                        <option value="good">áƒ™áƒáƒ áƒ’áƒ˜</option>
                        <option value="neutral">áƒ¡áƒáƒ¨áƒ£áƒáƒšáƒ</option>
                        <option value="bad">áƒªáƒ£áƒ“áƒ˜</option>
                        <option value="very_bad">áƒ«áƒáƒšáƒ˜áƒáƒœ áƒªáƒ£áƒ“áƒ˜</option>
                    </select>
                </div>
                
                <div class="question">
                    <label>5. áƒ›áƒ—áƒáƒ•áƒáƒ áƒ˜ áƒáƒ áƒ˜áƒáƒ áƒ˜áƒ¢áƒ”áƒ¢áƒ˜:</label>
                    <select name="priority" required>
                        <option value="">áƒáƒ˜áƒ áƒ©áƒ˜áƒ”áƒ—...</option>
                        <option value="economy">áƒ”áƒ™áƒáƒœáƒáƒ›áƒ˜áƒ™áƒ</option>
                        <option value="democracy">áƒ“áƒ”áƒ›áƒáƒ™áƒ áƒáƒ¢áƒ˜áƒ</option>
                        <option value="eu">áƒ”áƒ•áƒ áƒáƒ˜áƒœáƒ¢áƒ”áƒ’áƒ áƒáƒªáƒ˜áƒ</option>
                        <option value="security">áƒ£áƒ¡áƒáƒ¤áƒ áƒ—áƒ®áƒáƒ”áƒ‘áƒ</option>
                        <option value="education">áƒ’áƒáƒœáƒáƒ—áƒšáƒ”áƒ‘áƒ</option>
                    </select>
                </div>
                
                <button type="submit">áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ</button>
            </form>
        </div>
    </div>

    <div class="map-container">
        <div id="map"></div>
        
        <div class="sidebar">
            <h1>áƒ’áƒáƒ›áƒáƒ’áƒšáƒ”áƒ¯áƒMAP - áƒ¡áƒáƒ›áƒ¡áƒ˜áƒ¢áƒ§áƒ•áƒ˜áƒáƒœáƒ˜ Grid</h1>
            
            <!-- Tab Navigation -->
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('survey')">áƒ™áƒ˜áƒ—áƒ®áƒ•áƒáƒ áƒ˜</button>
                <button class="tab-btn" onclick="switchTab('results')">áƒ¨áƒ”áƒ“áƒ”áƒ’áƒ”áƒ‘áƒ˜</button>
            </div>
            
            <!-- Survey Tab -->
            <div id="surveyTab" class="tab-content active">
                <div class="section">
                    <h3>áƒ˜áƒœáƒ¡áƒ¢áƒ áƒ£áƒ¥áƒªáƒ˜áƒ</h3>
                    <p style="font-size: 12px; line-height: 1.6;">
                        â€¢ áƒ“áƒáƒáƒ™áƒšáƒ˜áƒ™áƒ” 200m x 200m grid áƒ£áƒ¯áƒ áƒ”áƒ“áƒ–áƒ” (áƒšáƒ£áƒ áƒ¯áƒ˜ áƒ™áƒ•áƒáƒ“áƒ áƒáƒ¢áƒ”áƒ‘áƒ˜)<br>
                        â€¢ áƒ—áƒ˜áƒ—áƒáƒ”áƒ£áƒš áƒ£áƒ¯áƒ áƒ”áƒ“áƒ¡ áƒáƒ¥áƒ•áƒ¡ áƒ£áƒœáƒ˜áƒ™áƒáƒšáƒ£áƒ áƒ˜ áƒ¡áƒáƒ›áƒ˜ áƒ¡áƒ˜áƒ¢áƒ§áƒ•áƒ˜áƒáƒœáƒ˜ áƒ¡áƒáƒ®áƒ”áƒšáƒ˜<br>
                        â€¢ áƒ¨áƒ”áƒáƒ•áƒ¡áƒ” áƒ™áƒ˜áƒ—áƒ®áƒ•áƒáƒ áƒ˜<br>
                        â€¢ áƒáƒáƒ¡áƒ£áƒ®áƒ”áƒ‘áƒ˜ áƒáƒ•áƒ¢áƒáƒ›áƒáƒ¢áƒ£áƒ áƒáƒ“ áƒ˜áƒœáƒáƒ®áƒ”áƒ‘áƒ Google Sheets-áƒ¨áƒ˜
                    </p>
                    <div style="font-size: 11px; margin-top: 10px; padding: 8px; background: #f5f5f5; border-radius: 3px;">
                        <span class="status-indicator" id="statusDot"></span>
                        <span id="connectionStatus">áƒ˜áƒœáƒ˜áƒªáƒ˜áƒáƒšáƒ˜áƒ–áƒáƒªáƒ˜áƒ...</span>
                    </div>
                </div>
                
                <div class="section">
                    <h3>áƒ¡áƒ¢áƒáƒ¢áƒ˜áƒ¡áƒ¢áƒ˜áƒ™áƒ</h3>
                    <div id="dataStatus" style="font-size: 12px; line-height: 1.8;">
                        <div>ğŸ“Š <strong>áƒ¡áƒ£áƒš áƒáƒáƒ¡áƒ£áƒ®áƒ˜:</strong> <span id="totalResponses">0</span></div>
                        <div>ğŸ—ºï¸ <strong>áƒ“áƒáƒ¤áƒáƒ áƒ£áƒšáƒ˜ áƒ£áƒ¯áƒ áƒ”áƒ“áƒ”áƒ‘áƒ˜:</strong> <span id="totalCells">0</span></div>
                    </div>
                </div>
            </div>
            
            <!-- Results Tab -->
            <div id="resultsTab" class="tab-content">
                <div class="section">
                    <h3>áƒáƒœáƒáƒšáƒ˜áƒ–áƒ˜áƒ¡ áƒáƒáƒ áƒáƒ›áƒ”áƒ¢áƒ áƒ”áƒ‘áƒ˜</h3>
                    <p style="font-size: 12px; margin-bottom: 10px;">
                        áƒ“áƒáƒáƒ™áƒšáƒ˜áƒ™áƒ” áƒ áƒ£áƒ™áƒáƒ–áƒ” áƒ¡áƒáƒ¡áƒ£áƒ áƒ•áƒ”áƒš áƒ¬áƒ”áƒ áƒ¢áƒ˜áƒšáƒ–áƒ” áƒ˜áƒ–áƒáƒ¥áƒ áƒáƒœáƒ˜áƒ¡ áƒ¨áƒ”áƒ¡áƒáƒ¥áƒ›áƒœáƒ”áƒšáƒáƒ“. áƒáƒ•áƒ¢áƒáƒ›áƒáƒ¢áƒ£áƒ áƒáƒ“ áƒáƒ’áƒ áƒ”áƒ’áƒ˜áƒ áƒ“áƒ”áƒ‘áƒ áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜ áƒ§áƒ•áƒ”áƒšáƒ áƒ’áƒáƒ“áƒáƒ›áƒ™áƒ•áƒ”áƒ—áƒ˜ áƒ£áƒ¯áƒ áƒ”áƒ“áƒ˜áƒ“áƒáƒœ.
                    </p>
                    <label>áƒ’áƒáƒ“áƒáƒáƒ“áƒ’áƒ˜áƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒ“áƒ áƒ (áƒ¬áƒ£áƒ—áƒ˜)</label>
                    <select id="timeResults">
                        <option value="10">10</option>
                        <option value="15" selected>15</option>
                        <option value="20">20</option>
                        <option value="25">25</option>
                        <option value="30">30</option>
                    </select>
                    
                    <label style="margin-top: 12px;">áƒ’áƒáƒ“áƒáƒáƒ“áƒ’áƒ˜áƒšáƒ”áƒ‘áƒ˜áƒ¡ áƒ¤áƒáƒ áƒ›áƒ</label>
                    <div class="toggle-group">
                        <div class="toggle active" data-mode="walking" onclick="setResultsMode('walking')">ğŸš¶ áƒ¤áƒ”áƒ®áƒ˜áƒ—</div>
                        <div class="toggle" data-mode="cycling" onclick="setResultsMode('cycling')">ğŸš´ áƒ•áƒ”áƒšáƒ</div>
                    </div>
                </div>
                
                <div id="aggregateResults" class="results" style="display: none;">
                    <h3 style="margin-bottom: 12px;">áƒáƒ’áƒ áƒ”áƒ’áƒ˜áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜ áƒ¨áƒ”áƒ“áƒ”áƒ’áƒ”áƒ‘áƒ˜</h3>
                    <div id="aggregateContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // GOOGLE SHEETS API CONFIGURATION
        // Replace these with your credentials from Google Cloud Console
        const CLIENT_ID = '233200756171-j1cncfsln826akqvc5dvdk7db9rrqtug.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBhG_FVUHo8UiYi6SgsnrsUDhEiobzvGio';
        const SPREADSHEET_ID = '12aeeqeidNNydNBs-e7xbOMw0jhV_LQQhKJEgt1be9rk'; // Create a Google Sheet and paste its ID here
        const DISCOVERY_DOC = 'https://sheets.googleapis.com/$discovery/rest?version=v4';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let currentTab = 'survey';
        let resultsMode = 'walking';
        let isGoogleConnected = false;
        
        // Georgian word list for three-word names
        const GEORGIAN_WORDS = [
            'áƒ›áƒ–áƒ”', 'áƒ›áƒ—áƒ', 'áƒ¬áƒ§áƒáƒšáƒ˜', 'áƒ®áƒ”', 'áƒ§áƒ•áƒáƒ•áƒ˜áƒšáƒ˜', 'áƒ¥áƒáƒ áƒ˜', 'áƒ¦áƒ áƒ£áƒ‘áƒ”áƒšáƒ˜', 'áƒ›áƒ“áƒ˜áƒœáƒáƒ áƒ”', 'áƒ¢áƒ‘áƒ', 'áƒ•áƒ”áƒšáƒ˜',
            'áƒ¢áƒ§áƒ”', 'áƒ¥áƒ•áƒ', 'áƒªáƒ', 'áƒ›áƒ˜áƒ¬áƒ', 'áƒ•áƒáƒ áƒ¡áƒ™áƒ•áƒšáƒáƒ•áƒ˜', 'áƒ›áƒ—áƒ•áƒáƒ áƒ”', 'áƒœáƒ˜áƒ¡áƒšáƒ˜', 'áƒ—áƒáƒ•áƒšáƒ˜', 'áƒ¬áƒ•áƒ˜áƒ›áƒ', 'áƒ áƒáƒ“áƒ˜áƒ',
            'áƒ¬áƒ˜áƒ’áƒœáƒ˜', 'áƒ¡áƒáƒ®áƒšáƒ˜', 'áƒ’áƒ–áƒ', 'áƒ®áƒ˜áƒ“áƒ˜', 'áƒ™áƒáƒ áƒ˜', 'áƒ¤áƒáƒœáƒ¯áƒáƒ áƒ', 'áƒ‘áƒáƒ¦áƒ˜', 'áƒ”áƒ–áƒ', 'áƒ¥áƒ£áƒ©áƒ', 'áƒ›áƒáƒ”áƒ“áƒáƒœáƒ˜',
            'áƒªáƒ˜áƒ®áƒ”', 'áƒ”áƒ™áƒšáƒ”áƒ¡áƒ˜áƒ', 'áƒ›áƒ£áƒ–áƒ”áƒ£áƒ›áƒ˜', 'áƒáƒáƒ áƒ™áƒ˜', 'áƒ‘áƒ£áƒšáƒ•áƒáƒ áƒ˜', 'áƒ¡áƒ™áƒ•áƒ”áƒ áƒ˜', 'áƒ¤áƒáƒœáƒ¢áƒáƒœáƒ˜', 'áƒ«áƒ”áƒ’áƒšáƒ˜', 'áƒ—áƒ”áƒáƒ¢áƒ áƒ˜', 'áƒ™áƒ˜áƒœáƒ',
            'áƒ§áƒ£áƒ áƒ«áƒ”áƒœáƒ˜', 'áƒ•áƒáƒ¨áƒšáƒ˜', 'áƒ›áƒ¡áƒ®áƒáƒšáƒ˜', 'áƒáƒ¢áƒáƒ›áƒ˜', 'áƒ¤áƒáƒ áƒ—áƒáƒ®áƒáƒšáƒ˜', 'áƒšáƒ˜áƒ›áƒáƒœáƒ˜', 'áƒŸáƒáƒšáƒ', 'áƒ™áƒ˜áƒ•áƒ˜', 'áƒ‘áƒáƒœáƒáƒœáƒ˜', 'áƒ¡áƒáƒ–áƒáƒ›áƒ—áƒ áƒ', 
            'áƒ¥áƒáƒªáƒ˜', 'áƒœáƒáƒªáƒ˜', 'áƒáƒšáƒ˜áƒ’áƒáƒ áƒ¥áƒ˜áƒ', 'áƒ áƒ£áƒ¡áƒ—áƒáƒ•áƒ”áƒšáƒ˜', 'áƒ‘áƒ˜áƒ«áƒ˜áƒœáƒáƒ®áƒ£áƒ˜', 
        ];
        
        mapboxgl.accessToken = "pk.eyJ1Ijoiam9yam9uZTkwIiwiYSI6ImNrZ3R6M2FvdTBwbmwycXBibGRqM2w2enYifQ.BxjvFSGqefuC9yFCrXC-nQ";
        
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/light-v11',
            center: [44.812, 41.741787],
            zoom: 13
        });
        
        map.addControl(new mapboxgl.NavigationControl());
        
        let marker = null;
        let gridData = {};
        let currentCell = null;
        const GRID_SIZE = 0.0018; // ~200 meters in degrees
        
        // Generate three-word name from cell coordinates
        function generateThreeWordName(cellId) {
            const [x, y] = cellId.split(',').map(Number);
            const hash = Math.abs((x * 73856093) ^ (y * 19349663));
            
            const word1 = GEORGIAN_WORDS[hash % GEORGIAN_WORDS.length];
            const word2 = GEORGIAN_WORDS[Math.floor(hash / GEORGIAN_WORDS.length) % GEORGIAN_WORDS.length];
            const word3 = GEORGIAN_WORDS[Math.floor(hash / (GEORGIAN_WORDS.length * GEORGIAN_WORDS.length)) % GEORGIAN_WORDS.length];
            
            return `${word1}.${word2}.${word3}`;
        }
        
        // Update connection status
        function updateConnectionStatus(connected, message = '') {
            isGoogleConnected = connected;
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('connectionStatus');
            
            if (connected) {
                statusDot.className = 'status-indicator status-connected';
                statusText.textContent = message || 'áƒ“áƒáƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜áƒ Google Sheets-áƒ—áƒáƒœ';
            } else {
                statusDot.className = 'status-indicator status-disconnected';
                statusText.textContent = message || 'áƒáƒ  áƒáƒ áƒ˜áƒ¡ áƒ“áƒáƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ”áƒ‘áƒ£áƒšáƒ˜';
            }
        }
        
        // Initialize Google API
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        
        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeAutoConnect();
        }
        
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gisInited = true;
            maybeAutoConnect();
        }
        
        function maybeAutoConnect() {
            if (gapiInited && gisInited) {
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) {
                        updateConnectionStatus(false, 'áƒ“áƒáƒ­áƒ˜áƒ áƒ”áƒ— áƒ áƒáƒ› áƒ“áƒáƒ£áƒ™áƒáƒ•áƒ¨áƒ˜áƒ áƒ“áƒ”áƒ—');
                        return;
                    }
                    updateConnectionStatus(true);
                    await loadDataFromSheets();
                };
                
                // Check if already has token
                const token = gapi.client.getToken();
                if (token !== null) {
                    updateConnectionStatus(true);
                    loadDataFromSheets();
                } else {
                    // First time - need user interaction
                    updateConnectionStatus(false, 'áƒ¡áƒáƒ­áƒ˜áƒ áƒáƒ áƒáƒ•áƒ¢áƒáƒ áƒ˜áƒ–áƒáƒªáƒ˜áƒ');
                    // You'll need a button for first-time auth
                }
            }
        }
        
        // Send data to Google Sheets (background)
        async function sendToGoogleSheets(data) {
            if (!isGoogleConnected || !SPREADSHEET_ID || SPREADSHEET_ID === '12aeeqeidNNydNBs-e7xbOMw0jhV_LQQhKJEgt1be9rk') {
                return false;
            }
            
            try {
                const values = [[
                    new Date(data.timestamp).toISOString(),
                    data.gridName,
                    data.cellId,
                    data.lat.toFixed(6),
                    data.lng.toFixed(6),
                    data.age,
                    data.gender,
                    data.vote,
                    data.economy,
                    data.priority
                ]];
                
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Sheet1!A:J',
                    valueInputOption: 'RAW',
                    resource: { values: values }
                });
                
                return true;
            } catch (err) {
                console.error('Google Sheets error:', err);
                return false;
            }
        }
        
        // Load data from Google Sheets (background)
        async function loadDataFromSheets() {
            if (!isGoogleConnected || !SPREADSHEET_ID || SPREADSHEET_ID === '12aeeqeidNNydNBs-e7xbOMw0jhV_LQQhKJEgt1be9rk') {
                return;
            }
            
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Sheet1!A2:J'
                });
                
                const rows = response.result.values || [];
                gridData = {};
                
                rows.forEach(row => {
                    if (row.length < 10) return;
                    const cellId = row[2];
                    const responseData = {
                        timestamp: new Date(row[0]).getTime(),
                        gridName: row[1],
                        cellId: cellId,
                        lat: parseFloat(row[3]),
                        lng: parseFloat(row[4]),
                        age: row[5],
                        gender: row[6],
                        vote: row[7],
                        economy: row[8],
                        priority: row[9]
                    };
                    
                    if (!gridData[cellId]) gridData[cellId] = [];
                    gridData[cellId].push(responseData);
                });
                
                updateGridLayer();
                updateDataStatus();
            } catch (err) {
                console.error('Error loading from Sheets:', err);
            }
        }
        
        // Initialize Google API when loaded
        if (typeof gapi !== 'undefined') {
            gapiLoaded();
        }
        window.addEventListener('load', () => {
            if (typeof google !== 'undefined' && google.accounts) {
                gisLoaded();
            }
        });
        
        // Update data status
        function updateDataStatus() {
            const total = Object.values(gridData).reduce((sum, arr) => sum + arr.length, 0);
            const cells = Object.keys(gridData).length;
            document.getElementById('totalResponses').textContent = total;
            document.getElementById('totalCells').textContent = cells;
        }
        
        // Tab switching
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'survey') {
                document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                document.getElementById('surveyTab').classList.add('active');
                // Clear results marker
                if (marker) marker.remove();
                marker = null;
                if (map.getSource('iso')) {
                    map.getSource('iso').setData({ type: 'FeatureCollection', features: [] });
                }
            } else {
                document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                document.getElementById('resultsTab').classList.add('active');
            }
        }
        
        function setResultsMode(mode) {
            resultsMode = mode;
            document.querySelectorAll('#resultsTab .toggle').forEach(t => t.classList.remove('active'));
            document.querySelector(`#resultsTab .toggle[data-mode="${mode}"]`).classList.add('active');
            if (marker && currentTab === 'results') generateResultsIsochrone(marker.getLngLat());
        }
        
        // Generate grid cell ID from coordinates
        function getCellId(lng, lat) {
            const x = Math.floor(lng / GRID_SIZE);
            const y = Math.floor(lat / GRID_SIZE);
            return `${x},${y}`;
        }
        
        // Get cell bounds from ID
        function getCellBounds(cellId) {
            const [x, y] = cellId.split(',').map(Number);
            const minLng = x * GRID_SIZE;
            const minLat = y * GRID_SIZE;
            return [
                [minLng, minLat],
                [minLng + GRID_SIZE, minLat],
                [minLng + GRID_SIZE, minLat + GRID_SIZE],
                [minLng, minLat + GRID_SIZE],
                [minLng, minLat]
            ];
        }
        
        // Get cell center
        function getCellCenter(cellId) {
            const bounds = getCellBounds(cellId);
            return [(bounds[0][0] + bounds[2][0]) / 2, (bounds[0][1] + bounds[2][1]) / 2];
        }
        
        // Aggregate results within isochrone
        function aggregateResultsInIsochrone(isochronePolygon) {
            const aggregated = {
                total: 0,
                age: {},
                gender: {},
                vote: {},
                economy: {},
                priority: {},
                grids: []
            };
            
            Object.keys(gridData).forEach(cellId => {
                const center = getCellCenter(cellId);
                const point = turf.point(center);
                
                if (turf.booleanPointInPolygon(point, isochronePolygon)) {
                    aggregated.grids.push({
                        name: generateThreeWordName(cellId),
                        count: gridData[cellId].length
                    });
                    
                    gridData[cellId].forEach(response => {
                        aggregated.total++;
                        aggregated.age[response.age] = (aggregated.age[response.age] || 0) + 1;
                        aggregated.gender[response.gender] = (aggregated.gender[response.gender] || 0) + 1;
                        aggregated.vote[response.vote] = (aggregated.vote[response.vote] || 0) + 1;
                        aggregated.economy[response.economy] = (aggregated.economy[response.economy] || 0) + 1;
                        aggregated.priority[response.priority] = (aggregated.priority[response.priority] || 0) + 1;
                    });
                }
            });
            
            return aggregated;
        }
        
        // Display aggregated results
        function displayAggregatedResults(data) {
            if (data.total === 0) {
                document.getElementById('aggregateContent').innerHTML = 
                    '<p style="text-align: center; color: #999; padding: 20px;">áƒáƒ› áƒáƒ áƒ”áƒáƒšáƒ¨áƒ˜ áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ”áƒ‘áƒ˜ áƒáƒ  áƒáƒ áƒ˜áƒ¡</p>';
                return;
            }
            
            const voteLabels = {
                qocebi: 'áƒ¥áƒáƒ áƒ—áƒ£áƒšáƒ˜ áƒáƒªáƒœáƒ”áƒ‘áƒ',
                lelo: 'áƒšáƒ”áƒšáƒ',
                gakharia: 'áƒ’áƒáƒ®áƒáƒ áƒ˜áƒ',
                boycott: 'áƒ‘áƒáƒ˜áƒ™áƒáƒ¢áƒ˜',
                undecided: 'áƒ’áƒáƒ“áƒáƒ£áƒ¬áƒ§áƒ•áƒ”áƒ¢áƒ”áƒšáƒ˜'
            };
            
            const priorityLabels = {
                economy: 'áƒ”áƒ™áƒáƒœáƒáƒ›áƒ˜áƒ™áƒ',
                democracy: 'áƒ“áƒ”áƒ›áƒáƒ™áƒ áƒáƒ¢áƒ˜áƒ',
                eu: 'áƒ”áƒ•áƒ áƒáƒ˜áƒœáƒ¢áƒ”áƒ’áƒ áƒáƒªáƒ˜áƒ',
                security: 'áƒ£áƒ¡áƒáƒ¤áƒ áƒ—áƒ®áƒáƒ”áƒ‘áƒ',
                education: 'áƒ’áƒáƒœáƒáƒ—áƒšáƒ”áƒ‘áƒ'
            };
            
            const economyLabels = {
                very_good: 'áƒ«áƒáƒšáƒ˜áƒáƒœ áƒ™áƒáƒ áƒ’áƒ˜',
                good: 'áƒ™áƒáƒ áƒ’áƒ˜',
                neutral: 'áƒ¡áƒáƒ¨áƒ£áƒáƒšáƒ',
                bad: 'áƒªáƒ£áƒ“áƒ˜',
                very_bad: 'áƒ«áƒáƒšáƒ˜áƒáƒœ áƒªáƒ£áƒ“áƒ˜'
            };
            
            let html = `<div class="aggregate-stat"><strong>áƒ¡áƒ£áƒš áƒáƒáƒ¡áƒ£áƒ®áƒ˜:</strong> ${data.total}</div>`;
            html += `<div class="aggregate-stat"><strong>áƒ’áƒáƒ“áƒáƒ›áƒ™áƒ•áƒ”áƒ—áƒ˜ áƒ£áƒ¯áƒ áƒ”áƒ“áƒ”áƒ‘áƒ˜:</strong> ${data.grids.length}</div>`;
            
            // Show grid names
            if (data.grids.length > 0) {
                html += '<div class="aggregate-stat" style="max-height: 100px; overflow-y: auto;"><strong>áƒ£áƒ¯áƒ áƒ”áƒ“áƒ”áƒ‘áƒ˜:</strong><br>';
                data.grids.forEach(grid => {
                    html += `<span style="font-size: 11px; color: #6c86cf;">${grid.name}</span> (${grid.count}) <br>`;
                });
                html += '</div>';
            }
            
            // Vote distribution
            html += '<h4 style="margin-top: 15px; margin-bottom: 8px; color: #333;">áƒáƒáƒ áƒ¢áƒ˜áƒ£áƒšáƒ˜ áƒ’áƒáƒ“áƒáƒœáƒáƒ¬áƒ˜áƒšáƒ”áƒ‘áƒ:</h4>';
            const sortedVotes = Object.entries(data.vote).sort((a, b) => b[1] - a[1]);
            sortedVotes.forEach(([key, count]) => {
                const pct = ((count / data.total) * 100).toFixed(1);
                html += `<div class="aggregate-stat">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span>${voteLabels[key] || key}</span>
                        <span><strong>${count}</strong> (${pct}%)</span>
                    </div>
                    <div class="chart-bar" style="width: ${pct}%;">
                        <span class="chart-label">${pct}%</span>
                    </div>
                </div>`;
            });
            
            // Priority distribution
            html += '<h4 style="margin-top: 15px; margin-bottom: 8px; color: #333;">áƒáƒ áƒ˜áƒáƒ áƒ˜áƒ¢áƒ”áƒ¢áƒ”áƒ‘áƒ˜:</h4>';
            const sortedPriority = Object.entries(data.priority).sort((a, b) => b[1] - a[1]);
            sortedPriority.forEach(([key, count]) => {
                const pct = ((count / data.total) * 100).toFixed(1);
                html += `<div class="aggregate-stat">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span>${priorityLabels[key] || key}</span>
                        <span><strong>${count}</strong> (${pct}%)</span>
                    </div>
                    <div class="chart-bar" style="width: ${pct}%;">
                        <span class="chart-label">${pct}%</span>
                    </div>
                </div>`;
            });
            
            // Economy assessment
            html += '<h4 style="margin-top: 15px; margin-bottom: 8px; color: #333;">áƒ”áƒ™áƒáƒœáƒáƒ›áƒ˜áƒ™áƒ˜áƒ¡ áƒ¨áƒ”áƒ¤áƒáƒ¡áƒ”áƒ‘áƒ:</h4>';
            const sortedEconomy = Object.entries(data.economy).sort((a, b) => b[1] - a[1]);
            sortedEconomy.forEach(([key, count]) => {
                const pct = ((count / data.total) * 100).toFixed(1);
                html += `<div class="aggregate-stat">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span>${economyLabels[key] || key}</span>
                        <span><strong>${count}</strong> (${pct}%)</span>
                    </div>
                    <div class="chart-bar" style="width: ${pct}%;">
                        <span class="chart-label">${pct}%</span>
                    </div>
                </div>`;
            });
            
            // Demographics
            html += '<h4 style="margin-top: 15px; margin-bottom: 8px; color: #333;">áƒ“áƒ”áƒ›áƒáƒ’áƒ áƒáƒ¤áƒ˜áƒ:</h4>';
            html += '<div class="aggregate-stat"><strong>áƒáƒ¡áƒáƒ™áƒ˜:</strong><br>';
            Object.entries(data.age).sort().forEach(([key, count]) => {
                const pct = ((count / data.total) * 100).toFixed(1);
                html += `<span style="font-size: 11px;">${key}: ${count} (${pct}%)</span> | `;
            });
            html += '</div>';
            
            html += '<div class="aggregate-stat"><strong>áƒ¡áƒ¥áƒ”áƒ¡áƒ˜:</strong><br>';
            const genderLabels = { male: 'áƒ›áƒáƒ›áƒ áƒáƒ‘áƒ˜áƒ—áƒ˜', female: 'áƒ›áƒ“áƒ”áƒ“áƒ áƒáƒ‘áƒ˜áƒ—áƒ˜', other: 'áƒ¡áƒ®áƒ•áƒ' };
            Object.entries(data.gender).forEach(([key, count]) => {
                const pct = ((count / data.total) * 100).toFixed(1);
                html += `<span style="font-size: 11px;">${genderLabels[key] || key}: ${count} (${pct}%)</span> | `;
            });
            html += '</div>';
            
            document.getElementById('aggregateContent').innerHTML = html;
        }
        
        // Modal setup
        const modal = document.getElementById('modal');
        document.querySelector('.close').onclick = () => modal.style.display = 'none';
        window.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };
        
        // Form submission
        document.getElementById('surveyForm').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const center = getCellCenter(currentCell);
            const gridName = generateThreeWordName(currentCell);

            const response = {
                age: formData.get('age'),
                gender: formData.get('gender'),
                vote: formData.get('vote'),
                economy: formData.get('economy'),
                priority: formData.get('priority'),
                timestamp: Date.now(),
                gridName: gridName,
                cellId: currentCell,
                lat: center[1],
                lng: center[0]
            };

            // Send to Google Apps Script
            try {
                await fetch('https://script.google.com/macros/s/AKfycbwEeMFvA2P2gEcyJPM4UzsE0OFIRA60bRMA9UqO0G8S3hvXbUblI17bhQJ9L3GaeUph/exec', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(response)
            })
            .then(r => r.json())
            .then(console.log);
                alert('áƒ›áƒáƒ“áƒšáƒáƒ‘áƒ! áƒ—áƒ¥áƒ•áƒ”áƒœáƒ˜ áƒáƒáƒ¡áƒ£áƒ®áƒ˜ áƒ¨áƒ”áƒœáƒáƒ®áƒ£áƒšáƒ˜áƒ.');
            } catch (err) {
                console.error(err);
                alert('áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ áƒ›áƒáƒœáƒáƒªáƒ”áƒ›áƒ˜áƒ¡ áƒ’áƒáƒ’áƒ–áƒáƒ•áƒœáƒ˜áƒ¡áƒáƒ¡');
            }

            // Update locally
            if (!gridData[currentCell]) gridData[currentCell] = [];
            gridData[currentCell].push(response);

            e.target.reset();
            modal.style.display = 'none';
            updateGridLayer();
            updateDataStatus();
        };
        
        // Update grid visualization
        function updateGridLayer() {
            const bounds = map.getBounds();
            const minLng = bounds.getWest();
            const maxLng = bounds.getEast();
            const minLat = bounds.getSouth();
            const maxLat = bounds.getNorth();
            
            const features = [];
            
            for (let lng = Math.floor(minLng / GRID_SIZE) * GRID_SIZE; lng <= maxLng; lng += GRID_SIZE) {
                for (let lat = Math.floor(minLat / GRID_SIZE) * GRID_SIZE; lat <= maxLat; lat += GRID_SIZE) {
                    const cellId = getCellId(lng, lat);
                    const coords = getCellBounds(cellId);
                    const count = gridData[cellId] ? gridData[cellId].length : 0;
                    
                    if (count > 0 || map.getZoom() > 12) {
                        features.push({
                            type: 'Feature',
                            properties: { 
                                cellId, 
                                count, 
                                hasData: count > 0,
                                gridName: generateThreeWordName(cellId)
                            },
                            geometry: { type: 'Polygon', coordinates: [coords] }
                        });
                    }
                }
            }
            
            if (map.getSource('grid')) {
                map.getSource('grid').setData({ type: 'FeatureCollection', features });
            }
        }
        
        // Map click handler
        map.on('click', (e) => {
            if (currentTab === 'survey') {
                // Survey mode - click on grid cells to fill questionnaire
                const features = map.queryRenderedFeatures(e.point, { layers: ['grid-layer'] });
                
                if (features.length > 0) {
                    currentCell = features[0].properties.cellId;
                    const count = gridData[currentCell] ? gridData[currentCell].length : 0;
                    const center = getCellCenter(currentCell);
                    const gridName = generateThreeWordName(currentCell);
                    
                    document.getElementById('cellInfo').innerHTML = 
                        `<div class="three-word-name">${gridName}</div>` +
                        `<strong>Grid ID:</strong> ${currentCell}<br>` +
                        `<strong>áƒªáƒ”áƒœáƒ¢áƒ áƒ˜:</strong> ${center[1].toFixed(6)}, ${center[0].toFixed(6)}<br>` +
                        `<strong>áƒ–áƒáƒ›áƒ:</strong> ~200m x 200m<br>` +
                        `<strong>áƒáƒ áƒ¡áƒ”áƒ‘áƒ£áƒšáƒ˜ áƒáƒáƒ¡áƒ£áƒ®áƒ”áƒ‘áƒ˜:</strong> ${count}`;
                    modal.style.display = 'block';
                }
            } else {
                // Results mode - create isochrone and aggregate data
                if (marker) marker.remove();
                marker = new mapboxgl.Marker({ color: '#6c86cf' }).setLngLat(e.lngLat).addTo(map);
                generateResultsIsochrone(e.lngLat);
            }
        });
        
        // Generate isochrone for results analysis
        function generateResultsIsochrone(lngLat) {
            const time = document.getElementById('timeResults').value;
            const url = `https://api.mapbox.com/isochrone/v1/mapbox/${resultsMode}/${lngLat.lng},${lngLat.lat}?contours_minutes=${time}&polygons=true&access_token=${mapboxgl.accessToken}`;
            
            fetch(url)
                .then(r => r.json())
                .then(data => {
                    if (map.getSource('iso')) {
                        map.getSource('iso').setData(data);
                    }
                    
                    // Aggregate data within isochrone
                    if (data.features && data.features.length > 0) {
                        const aggregated = aggregateResultsInIsochrone(data.features[0]);
                        displayAggregatedResults(aggregated);
                        document.getElementById('aggregateResults').style.display = 'block';
                    }
                })
                .catch(err => {
                    console.error('Isochrone error:', err);
                    alert('áƒ¨áƒ”áƒªáƒ“áƒáƒ›áƒ áƒ˜áƒ–áƒáƒ¥áƒ áƒáƒœáƒ˜áƒ¡ áƒ¨áƒ”áƒ¥áƒ›áƒœáƒ˜áƒ¡áƒáƒ¡');
                });
        }
        
        // Time change for results
        document.getElementById('timeResults').onchange = () => {
            if (marker && currentTab === 'results') generateResultsIsochrone(marker.getLngLat());
        };
        
        // Initialize map layers
        map.on('load', () => {
            // Grid layer
            map.addSource('grid', {
                type: 'geojson',
                data: { type: 'FeatureCollection', features: [] }
            });
            
            map.addLayer({
                id: 'grid-layer',
                type: 'fill',
                source: 'grid',
                paint: {
                    'fill-color': [
                        'case',
                        ['>', ['get', 'count'], 0],
                        ['interpolate', ['linear'], ['get', 'count'],
                            1, '#e3f0fc',
                            5, '#6c86cf',
                            10, '#4a6bb0'
                        ],
                        '#ffffff'
                    ],
                    'fill-opacity': 0.3
                }
            });
            
            map.addLayer({
                id: 'grid-outline',
                type: 'line',
                source: 'grid',
                paint: {
                    'line-color': '#6c86cf',
                    'line-width': 1,
                    'line-opacity': 0.5
                }
            });
            
            // Isochrone layer
            map.addSource('iso', {
                type: 'geojson',
                data: { type: 'FeatureCollection', features: [] }
            });
            
            map.addLayer({
                id: 'iso-layer',
                type: 'fill',
                source: 'iso',
                paint: {
                    'fill-color': '#6c86cf',
                    'fill-opacity': 0.2
                }
            });
            
            map.addLayer({
                id: 'iso-outline',
                type: 'line',
                source: 'iso',
                paint: {
                    'line-color': '#6c86cf',
                    'line-width': 2
                }
            });
            
            updateGridLayer();
        });
        
        map.on('moveend', updateGridLayer);
        map.on('zoomend', updateGridLayer);
        
        // Initial setup
        updateConnectionStatus(false, 'áƒ˜áƒœáƒ˜áƒªáƒ˜áƒáƒšáƒ˜áƒ–áƒáƒªáƒ˜áƒ...');
        updateDataStatus();
    </script>
</body>
</html>